{% extends "base.html" %}
{% import "bootstrap/wtf.html" as wtf %}
{% import "_macros.html" as macros %}

{% block title %}项目进度管理系统{% endblock %}
{% block body_attribs %}
{% endblock %}
{% block head %}
{{ super() }}
<style type="text/css">
.bignumber {font-size:40px;}
</style>
<script type="text/javascript">
      var xmlhttp;
      var finish_steps_length = {{ finish_steps_length }};
      var steps_length = {{ steps_length }};
      //以下是jquery 完成步骤函数

    $(document).ready(function(){
        $("#create_modal").click(function(){
        $("#create_project").modal({backdrop: true});
    });
        $("#add_modal").click(function(){
        $("#addNewUsers").modal({backdrop: true});
    });
        $("#minus_modal").click(function(){
        $("#removeUsers").modal({backdrop: true});
    });
        $(".btn-danger").click(function(){
            var sid = $(this).attr("id");
            $("#finish_step_remark").modal({backdrop: "static"});
            $("#step_finish_button").click(function (){
                var remark_text = $("#finish_remark").val();
                $.post("/step/finish/"+sid,
                {
                    remark:remark_text
                },
                function(data,status){
                    if(status === 'success'){
                        var dataObj=eval("("+data+")");
                        if(dataObj.p_status === 1){
                             window.location.reload();
                         }
                        else {
                             $('#finish_step_remark').modal('hide');
                             $('#'+dataObj.sid).attr("class","btn btn-success");
                             $('#'+dataObj.sid).text("已解决");
                             $('#'+dataObj.sid).parent().append('<a class="btn btn-inverse" role="button" href="/project/step/'+dataObj.sid+'/cancel">撤销 </a>');
                             $('#'+'remark'+dataObj.sid).text(remark_text);
                             finish_steps_length = dataObj.finish_steps_length;
                             var progress = (finish_steps_length / steps_length) * 100;
                             $("#progress-bar").attr("aria-valuenow", progress);
                             $("#progress-bar").attr("style", "width:"+ progress +"%");}


                         }
                });
            });

            })

    });



</script>

{% endblock %}

{% block page_content %}
<div class="container-fluid">
  <div class="row">
    <!-- 第一个网格 显示user项目信息 -->
    <div class="col-md-2 col-md-offset-1">
            <a class="btn btn-primary" role="button"  id="create_modal"
       style="margin-top:10px;margin-bottom:10px;">+ 新建一个项目</a>
    {% if projects == [] %}
        <h4> 没有项目 </h4>
    {% else %}
        <h6><span class="glyphicon glyphicon-th-large"> </span>  我参与的项目 </h6>
        <div class="list-group">
            {% for p in projects %}
                {% if not p.status %}
                 {% if p == project %}
                 <a href="{{ url_for('.project', project_id=p.id) }}" class="list-group-item active">{{ p.name }}
                     <span class="badge">id:{{ p.id }}</span></a>
                 {% else %}
                    <a href="{{ url_for('.project', project_id=p.id) }}" class="list-group-item">
                        {{ p.name }}
                    </a>
                    {% endif %}
                 {% endif %}
            {%  endfor %}
        </div>
        <h6> <span class="glyphicon glyphicon-ok"> </span>  已完成的任务 </h6>
       <div class="list-group">
            {% for p in projects %}
                {% if p.status %}
                 {% if p == project %}
                 <a href="{{ url_for('.project', project_id=p.id) }}" class="list-group-item active">{{ p.name }}
                     <span class="badge">id:{{ p.id }}</span></a>
                 {% else %}
                    <a href="{{ url_for('.project', project_id=p.id) }}"class="list-group-item list-group-item-success">
                        {{ p.name }}
                    </a>
                    {% endif %}
                 {% endif %}
            {%  endfor %}
        </div>
    {% endif %}
    </div>
    <!-- /.第一个网格结束 -->

    <!-- 中间网格 显示当前项目信息 -->
    <div class="col-md-7" >
        {% if project != None %}
            {% if project.status %}
                <div class="panel panel-success">
            {% elif (remained_days | days_output) >= 0  %}
                <div class="panel panel-info">
            {% else %}
                <div class="panel panel-danger">
            {% endif %}
      <!-- Default panel contents -->
      <div class="panel-heading">
          <h5>{{ project.name }}</h5>
              {% if project.status %}
                  <h7 id="project_time" class="text-right">
                  项目时间：{{ project.start_time | date_output }} 至 {{ project.finish_at | date_output }}
                  </h7>
                  <h7 id="project_status" class="text-right">
                  <span class="glyphicon glyphicon-ok-circle" aria-hidden="true"></span> 项目已完成
                  </h7>
              {% elif (remained_days | days_output) >= 0  %}
                  <h6 id="project_time" class="text-right">
                  项目时间：{{ project.start_time | date_output }} 至 {{ project.expected_finish_at | date_output }}
                  </h6>
                  <h6 id="project_status" class="text-right">
                  <span class="glyphicon glyphicon-time" aria-hidden="true"> </span> 剩下
                      <span class="bignumber">{{ remained_days | days_output }}</span>天
                  </h6>
              {% else %}
                  <h6 id="project_time" class="text-right">
                  项目时间：{{ project.start_time | date_output }} 至 {{ project.expected_finish_at | date_output }}
                  </h6>
                  <h6 id="project_status" class="text-right">
                  <span class="glyphicon glyphicon-time" aria-hidden="true"> </span> 项目超期
                      <span class="bignumber">{{ remained_days | days_output | negate }}</span> 天
                  </h6>
              {% endif %}
      </div>

        <div class="panel-body">
          <h6> {{ project.content }}</h6>
        </div>
        <div class="progress"  style="margin-top:0px;margin-bottom:20px;">
          <div id="progress-bar" class="progress-bar progress-bar-success" role="progressbar"
               aria-valuenow="{{ progress }}" aria-valuemin="0" aria-valuemax="100" style="width: {{ progress }}%">
            <span class="sr-only"></span>
          </div>
        </div>
      <!-- Table -->
      <table class="table table-hover">
        <thead>
          <tr>
            <th >content</th>
            <th>position</th>
             <th>remark</th>

          </tr>
        </thead>
       {% for s in project.steps %}
        <tbody>
          <tr >
            <td width="60%"> <h7> {{ s.content }} </h7></td>
            <td width="20%">
                {% if  s.status  %}
                    <a class="btn btn-success" role="button" > 已解决 </a>
                     {% if current_user == project.creator %}
                           <a class="btn btn-inverse" role="button" href="{{ url_for('main.step_status_cancel', sid=s.id) }}">
                               撤销
                           </a>
                     {% endif %}
                {% else %}
                    <a class="btn btn-danger" role="button" id="{{ s.id }}"
                            {% if current_user != project.creator %} disabled="disabled"{% endif %}> 待解决 </a>

                {% endif %}
            </td>
             <td width="20%" id="remark{{ s.id }}">
                {% if s.finish_remark != None %} {{ s.finish_remark }} {% endif %}
             </td>

          </tr>
        </tbody>
     {% endfor %}
      </table>
    </div>
    <div>
    <h6><strong> 时间线</strong> </h6>
    <table class="table table-hover">
    <thead>
      <tr>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      </tr>
    </thead>
    <tbody>
    {% for c in commits[::-1] %}
          <tr>
            <td width="15%" style="font-size: 16px;">{{ moment(c.create_at).fromNow(refresh=True) }} </td>
            <td width="15%" style="font-size: 16px;">
               <span style="color: #007fff">[{{ c.branch }}] </span>
            </td>
            <td width="35%" style="font-size: 16px;">  <span style="color: #76231f">[{{ c.ref }}]</span> </td>
            <td width="40%" style="font-size: 16px;">  by {{ c.cname }} < {{ c.cemail }} > </td>
          </tr>
    {% endfor %}
        </tbody>
         </table>
    </div>
{% endif %}
</div>
<!-- /.中间网格结束-->

    <!-- 第三个网格 显示项目的成员 -->
    {% if projects != [] %}
    <div class="col-md-1">
                <h6><span class="glyphicon glyphicon-user"> </span> 项目成员</h6>
        <ul class="list-group">
        <li class="list-group-item active text-center "> <span class="glyphicon glyphicon-tag"> </span>
            {{ project.creator.name }}</li>
        {% for u in project.users %}
            <li class="list-group-item text-center" style="font-size: 16px" >{{ u.name }}</li>
        {% endfor %}
        <a id="add_modal" class="list-group-item text-center" style="color: #31b0d5">
        <span class="glyphicon glyphicon-plus-sign"> </span>
        </a>
        {% if current_user == project.creator %}
        <a id="minus_modal" class="list-group-item text-center" style="color: #d53922">
        <span class="glyphicon glyphicon-minus-sign"> </span>
        </a>
        {% endif %}
       </ul>
    </div>
        <!-- /.第三个网格 结束 -->
    {% endif %}
      </div>
        <!-- /.row 结束 -->
</div>
<!-- /.contain 结束 -->


<!-- 模态框1（Modal）创建项目用 -->
<div class="modal fade" id="create_project" tabindex="-1" role="dialog"
   aria-labelledby="myModalLabel" aria-hidden="true" >
   <div class="modal-dialog">
      <div class="modal-content">
         <div class="modal-header"  style="background-color: rgba(19, 19, 19, 0.77)">
            <button type="button" class="close"
               data-dismiss="modal" aria-hidden="true" style="color: #ffffff">
                  &times;
            </button>
            <h6 class="modal-title" id="myModalLabel" style="color: #ffffff">
               创建新项目
            </h6>
         </div>
         <div class="modal-body">
                    <form id="createProject" name="createProject"  method="POST" role="form" action=/create_project>
                    <div class="form-group">
                        <label for="inputName">项目名称</label>
                        <input type="text" class="form-control" id="name" name="name">
                    </div>
                    <div class="form-group">
                         <label for="inputContent">项目内容</label>
                         <textarea  type="text" class="form-control"  rows="3" id="content" name="content"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="date">项目起始时间</label>
                        <input type="text" class="form-control"  id="datepicker1" name="start_time">
                    </div>
                    <div class="form-group">
                        <label for="date">预期完成时间</label>
                        <input type="text" class="form-control"  id="datepicker2" name="finish_time">
                    </div>
                    <div id="step_groups">
                    <div class="form-group" id="1">
                        <label for="inputStep1">步骤1(必需)</label>
                        <input type="text" class="form-control" id="step1" name="step1">
                    </div>
                    </div>
                    <div style="margin-top:20px;margin-bottom:20px;">
                        <a class="btn btn-info"   id="add"  >  +  </a>          <a class="btn btn-warning"   id="decrease"  > - </a>
                    </div>
                    <div class="modal-footer">
                    <button type="submit" class="btn btn-primary" >创建</button>
                    </div>
                    </form>
                </div>
      </div><!-- /.modal-content -->
</div><!-- /.modal -->
</div>
   <!-- /.创建项目框结束 -->


<!-- 模态框2（Modal）添加成员用 -->
<div class="modal fade" id="addNewUsers" tabindex="-1" role="dialog"
   aria-labelledby="myModalLabel" aria-hidden="true">
   <div class="modal-dialog">
      <div class="modal-content">
         <div class="modal-header" style="background-color: rgba(19, 19, 19, 0.77)">
            <button type="button" class="close"
               data-dismiss="modal" aria-hidden="true" style="color: #ffffff">
                  &times;
            </button>
            <h6 class="modal-title" id="myModalLabel"style="color: #ffffff">
               添加成员
            </h6>
         </div>
         <div class="modal-body">
              <form id="addUser" name="addUser"  method="POST" role="form" action="/project/{{ project.id }}/addUser">
                  {% for u in other_users %}
                  <div class="form-group">
                      <label>
                          <h4><input type="checkbox" id="choice" name="{{ u.id }}"> {{ u.name }}</h4>
                      </label>

                  </div>
                   {% endfor %}
                  <div class="modal-footer">
                  <button type="submit" class="btn btn-primary"  >确认添加</button>
                  </div>
              </form>

         </div>
      </div><!-- /.modal-content -->
</div><!-- /.modal -->
</div>
   <!-- /.添加成员项目框结束 -->

<!-- 模态框3（Modal）移除成员用 -->
<div class="modal fade" id="removeUsers" tabindex="-1" role="dialog"
   aria-labelledby="myModalLabel" aria-hidden="true">
   <div class="modal-dialog">
      <div class="modal-content">
         <div class="modal-header" style="background-color: rgba(19, 19, 19, 0.77)">
            <button type="button" class="close"
               data-dismiss="modal" aria-hidden="true" style="color: #ffffff">
                  &times;
            </button>
            <h6 class="modal-title" id="myModalLabel"style="color: #ffffff">
               移除成员
            </h6>
         </div>
         <div class="modal-body">
              <form id="removeForm" name="removeForm"  method="POST" role="form" action="/project/{{ project.id }}/removeUser">
                  {% for u in project.users %}
                  {% if u != current_user and u != project.creator %}
                  <div class="form-group">
                      <label>
                          <h4><input type="checkbox" id="choice" name="{{ u.id }}"> {{ u.name }}</h4>
                      </label>
                  </div>
                      {% endif %}
                   {% endfor %}
                  <div class="modal-footer">
                  <button type="submit" class="btn btn-primary"  >确认移除</button>
                  </div>
              </form>

         </div>
      </div><!-- /.modal-content -->
</div><!-- /.modal -->
</div>
   <!-- /.添加成员项目框结束 -->

<!-- 模态框4（Modal）完成步骤的时候用到，主要是在原来的基础上添加备注 -->
<div class="modal fade" id="finish_step_remark" tabindex="-1" role="dialog"
   aria-labelledby="myModalLabel" aria-hidden="true">
   <div class="modal-dialog">
      <div class="modal-content">
         <div class="modal-header">
            <button type="button" class="close"
               data-dismiss="modal" aria-hidden="true">
                  &times;
            </button>
            <h6 class="modal-title" id="myModalLabel">
               完成步骤
            </h6>
         </div>
         <div class="modal-body">
                    <div class="form-group">
                         <label for="inputContent">备注内容</label>
                         <textarea  type="text" class="form-control"  rows="3" id="finish_remark" name="step_finish_remark"></textarea>
                    </div>
             <div class="modal-footer">
              <button class="btn btn-primary" id="step_finish_button" >确认完成</button>
             </div>
         </div>
      </div><!-- /.modal-content -->
</div><!-- /.modal -->
</div>
   <!-- /.添加成员项目框结束 -->

<script>
//创建project模拟框的两个时间选择器触发函数
$( "#datepicker1" ).datepicker({
	inline: true
});
$( "#datepicker2" ).datepicker({
	inline: true
});
</script>
<script>
    //下面是模拟框提交创建project的函数
$(document).ready(function(){
    $("#add").click(function(){
        var n = $("#step_groups").find("div").length + 1 ;
        var trHTML = " <div class='form-group' style='margin-top:15px;margin-bottom:15px;'><label for='inputStep1'>步骤"
                + n + "</label> <input type='text' class='form-control' id='step"+
                n + "' name='step"+ n + "'> </div>";
        $("#1").append(trHTML);

    });
    $("#decrease").click(function(){
        if(($("#step_groups").find("div").length) > 1){
        $("#step_groups").find("div").last().remove() ;}
    });
});
</script>
{% endblock %}
